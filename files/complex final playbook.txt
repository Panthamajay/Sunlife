---
- hosts: localhost
  name: "deploys a cloud formation stack which creates a Sagemaker Execution IAM Role"
  vars:
    access_type: "{{request_variable_access_to_prod}}"
    stack_name_prefix: slf-aws-edtadmin-sagemaker-iam-execution
    environment_type: "{{ Environment }}"
    deployment_region: "{{ region }}"
    dev_prod_slf_notebook_execution_role_template_url: "{{ dev_prod_slf_notebook_execution_role_template_url }}"
    US_dev_prod_slf_notebook_execution_role_template_url: "{{ US_dev_prod_slf_notebook_execution_role_template_url }}"
    lab_slf_notebook_execution_role_template_url: "{{ lab_slf_notebook_execution_role_template_url }}"
    US_lab_slf_notebook_execution_role_template_url: "{{ US_lab_slf_notebook_execution_role_template_url }}"
    
  tasks:
    - name: Get RoleType,RoleID and stack_name when user requests for a personal notebook
      set_fact:
        RoleType : personal
        RoleID : "{{ request_variable_requested_for_acf2 }}"
        stack_name : "{{ stack_name_prefix }}-personal-{{ request_variable_requested_for_acf2 }}"
      when: access_type == "Personal Workspace"

    - name: Get RoleType,RoleID and stack_name when user requests for a project notebook
      set_fact:
        RoleType : project
        RoleID : "{{ project_code }}"           # ? mappiing key i.e, project_code = csanalytics
        stack_name : "{{ stack_name_prefix }}-{{project_code}}"
      when: access_type != "Personal Workspace"
    
    - name: Get cloudformation template url when environment "Dev/Prod"  & region "ca-central-1"
      set_fact:
        template_url: "{{ dev_prod_slf_notebook_execution_role_template_url }}"
      when: (environment_type == "Dev" or environment_type == "Prod") and deployment_region == "ca-central-1"  
    
    - name: Get cloudformation template url when environment "Lab"  & region "ca-central-1"
      set_fact:
        template_url: "{{ lab_slf_notebook_execution_role_template_url }}"
      when: environment_type == "Lab" and deployment_region == "ca-central-1"
    
    - name: Get cloudformation template url when environment "dev/prod" & region "us-east-1"
      set_fact:
        template_url: "{{ US_dev_prod_slf_notebook_execution_role_template_url }}"
      when: (environment_type == "Dev" or environment_type == "Prod") and deployment_region == "us-east-1" 
    
    - name: Get cloudformation template url when environment "Lab" & region "us-east-1"
      set_fact:
        template_url: "{{ US_lab_slf_notebook_execution_role_template_url }}"
      when: environment_type == "Lab"  and deployment_region == "us-east-1"
    
    - name: create a Sagemaker execution IAM role stack for slf_aws_sagemaker_notebook
      cloudformation:
        stack_name: "{{ stack_name }}"
        state: "present"
        region: "{{ region }}"
        disable_rollback: true
        role_arn: "{{ iam_role_arn }}"
        template_url: "{{ template_url }}"
        template_parameters:
          Environment: "{{ Environment }}"
          RoleType: "{{ RoleType }}"
          RoleID: "{{ RoleID }}"
          CostCentre: "{{ request_variable_cost_centre_personal_or_project }}"
          GovtClearance: "{{ GovtClearance }}"
        tags:
          Stack: "{{ stack_name }}"
      register: IAM_exec_role_cft_output

    - name: printing the captured return result from execution of above task
      debug:
        var: IAM_exec_role_cft_output

    - name: writing registered cft output into a file
      copy:
        content: "{{ IAM_exec_role_cft_output }}"
        dest: Logs/{{ stack_name }}-{{ deployment_region }}logs.log