AWSTemplateFormatVersion: 2010-09-09
Description: >
              This Cloudformation template creates an Sagemaker Execution IAM Role.
Mappings:
  EnvironmentMap:
    Lab:
      WorkspaceBucketArn: "arn:aws:s3:::slf-ca-lab-workspace"
      WorkspaceKmsKeyID: "arn:aws:kms:us-east-2:932489359553:key/14415aae-53a7-49de-bf80-ce5c56183a31"
      NotebookKmsKeyID: "arn:aws:kms:us-east-2:932489359553:key/14415aae-53a7-49de-bf80-ce5c56183a31"
      NonPIIBucketArn: "arn:aws:s3:::slf-ca-lab-edl-nonpii-cpy"
      NonPIIBucketKMSKeyID: "aarn:aws:kms:us-east-2:932489359553:key/14415aae-53a7-49de-bf80-ce5c56183a31"
      UnstruDDSBucketArn: "arn:aws:s3:::slf-ca-lab-edl-unstr-dds"
    Dev:
      WorkspaceBucketArn: "arn:aws:s3:::slf-ca-dev-workspace"
      WorkspaceKmsKeyID: "arn:aws:kms:us-east-2:932489359553:key/14415aae-53a7-49de-bf80-ce5c56183a31"
      NotebookKmsKeyID: "arn:aws:kms:us-east-2:932489359553:key/14415aae-53a7-49de-bf80-ce5c56183a31"
      NonPIIBucketArn: "arn:aws:s3:::slf-ca-dev-edl-nonpii-cpy"
      NonPIIBucketKMSKeyID: "arn:aws:kms:us-east-2:932489359553:key/14415aae-53a7-49de-bf80-ce5c56183a31"
      UnstruDDSBucketArn: "arn:aws:s3:::slf-ca-dev-edl-unstr-dds"
    Prod:
      WorkspaceBucketArn: "arn:aws:s3:::slf-ca-prod-workspace"
      WorkspaceKmsKeyID: "arn:aws:kms:us-east-2:932489359553:key/14415aae-53a7-49de-bf80-ce5c56183a31"
      NotebookKmsKeyID: "arn:aws:kms:us-east-2:932489359553:key/14415aae-53a7-49de-bf80-ce5c56183a31"
      NonPIIBucketArn: "arn:aws:s3:::slf-ca-prd-edl-nonpii-cpy"
      NonPIIBucketKMSKeyID: "arn:aws:kms:us-east-2:932489359553:key/14415aae-53a7-49de-bf80-ce5c56183a31"
      UnstruDDSBucketArn: "arn:aws:s3:::slf-ca-prd-edl-unstr-dds"
Parameters:
  Environment:
    Description: "AWS Environment"
    Type: String
    Default: "Prod"
    AllowedValues:
      - "Lab"
      - "Dev"
      - "Prod"
  RoleType:
    Description: "Personal, Project or Deployment IAM Role"
    Type: String
    AllowedValues:
      - "personal"
      - "project"
      - "deployment"
  RoleID:
    Description: "ACF2-ID of Data Scientist or Project Code"
    Type: String
  CostCentre:
    Description: "Cost Centre"
    Type: String
  GovtClearance:
    Description: "This user/project role will only be used by notebooks for users having Government clearance"
    Type: String
    Default: false
    AllowedValues:
      - true
      - false
Conditions:
  ProjectRole: !Equals [ !Ref RoleType, project ]
  PersonalRole: !Equals [ !Ref RoleType, personal ]
  DeploymentRole: !Equals [!Ref RoleType, deployment]
  NotDeploymentRole: !Not [Condition: DeploymentRole]
  NotPersonalRole: !Not [Condition: PersonalRole]
  GovtClear: !Equals [ !Ref GovtClearance, true]
Resources:
  SagemakerExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Principal:
              Service:
                - "sagemaker.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      RoleName: !Join [ "_", [ "slf_aws_sagemaker", !Ref RoleType, !Ref RoleID, "execution_role" ] ]
  IAMPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: NotDeploymentRole
    Properties:
      ManagedPolicyName: !Join ["_", [ "slf_aws_sagemaker", !Ref RoleType, !Ref RoleID, "execution_policy" ] ]
      Description: !Join [" - ", [ "Execution Policy for", !Ref RoleType, !Ref RoleID ] ]
      Path: "/"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        -
          Sid: "AllowListingSagemakerObjects"
          Effect: "Allow"
          Action:
           - "sagemaker:ListTags"
           - "sagemaker:ListCodeRepositories"
           - "sagemaker:ListNotebookInstances"
           - "sagemaker:ListTrainingJobs"
           - "sagemaker:ListHyperParameterTuningJobs"
           - "sagemaker:ListTrainingJobsForHyperParameterTuningJob"
           - "sagemaker:ListModels"
           - "sagemaker:ListTransformJobs"
           - "sagemaker:ListAlgorithms"
           - "sagemaker:ListModelPackages"
           - "sagemaker:ListProcessingJobs"
          Resource: "*"
        -
          Sid: "DescribeSagemakerObjects"
          Effect: "Allow"
          Action:
           - "sagemaker:DescribeNotebookInstance"
           - "sagemaker:DescribeTrainingJob"
           - "sagemaker:DescribeHyperParameterTuningJob"
           - "sagemaker:DescribeModel"
           - "sagemaker:DescribeAlgorithm"
           - "sagemaker:DescribeModelPackage"
           - "sagemaker:DescribeTransformJob"
           - "sagemaker:DescribeCodeRepository"
           - "sagemaker:DescribeProcessingJob"
          Resource:
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:notebook-instance/", !If [ProjectRole, !Join ["-", [ "*", !Ref RoleID ] ], !Ref RoleID ] ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:notebook-instance/", !If [ProjectRole, !Join ["-", [ "*", !Ref RoleID, "small" ] ], !Ref RoleID ] ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:notebook-instance/", !If [ProjectRole, !Join ["-", [ "*", !Ref RoleID, "large" ] ], !Ref RoleID ] ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:notebook-instance/", !If [ProjectRole, !Join ["-", [ "*", !Ref RoleID, "gpu" ] ], !Ref RoleID ] ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:training-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:hyper-parameter-tuning-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:algorithm/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:model/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:model-package/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:transform-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:code-repository/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:processing-job/", !Ref RoleID, "*" ] ]
        -
          Sid: "AllowDescribeVPCInfo"
          Effect: "Allow"
          Action:
           - "ec2:DescribeVpcs"
           - "ec2:DescribeDhcpOptions"
           - "ec2:DescribeSubnets"
           - "ec2:DescribeSecurityGroups"
           - "ec2:DescribeAvailabilityZones"
           - "ec2:DescribeInternetGateways"
           - "ec2:DescribeNetworkInterfaces"
          Resource: '*'
          Condition:
            ForAnyValue:StringEquals:
              "aws:RequestedRegion": !Sub "${AWS::Region}"
        -
          Sid: "AllowBucketLocationPermissions"
          Effect: "Allow"
          Action:
           - "s3:GetBucketLocation"
          Resource: !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceBucketArn"]
        -
          Sid: "AllowListS3BucketWithPrefix"
          Effect: "Allow"
          Action:
           - "s3:ListBucket"
          Resource:
           - !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceBucketArn"]
           - !FindInMap ["EnvironmentMap", !Ref Environment,"UnstruDDSBucketArn"]
          Condition:
            ForAnyValue:StringLike:
              "s3:prefix":
               - !Join [ "" , [ !If [ProjectRole, "PrW", "MyW" ], "/", !Ref RoleID, "/", "*" ] ]
               - !Join [ "" , [ "ART", "/", !Ref RoleID, "/", "*" ] ]
               - "Configuration/*"
               - !Join [ "" , [ "dds", "/", !Ref RoleID, "/", "*" ] ]
        -
          Sid: "AllowListS3BucketNonPiiWithPrefix"
          Effect: "Allow"
          Action:
           - "s3:ListBucket"
          Resource:
           - !FindInMap ["EnvironmentMap", !Ref Environment,"NonPIIBucketArn"]
          Condition:
            ForAnyValue:StringLike:
              "s3:prefix":
               - "cur/*"
               - "der/*"
               - "dds/*"
        -
          Sid: "AllowReadOfNonPiiBucket"
          Effect: "Allow"
          Action:
           - "s3:GetObject"
          Resource:
           - !If [GovtClear, !Join [ "/" , [ !FindInMap ["EnvironmentMap", !Ref Environment,"NonPIIBucketArn"], "*" ] ], !Join [ "/" , [ !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceBucketArn"], !If [ProjectRole, "PrW", "MyW" ], "nonpiidenied", "*" ] ] ]
        -
          Sid: "AllowReadWriteToWorkspaceAndArtifacts"
          Effect: "Allow"
          Action:
           - "s3:ListObjectsV2"
           - "s3:PutObject"
           - "s3:GetObject"
           - "s3:DeleteObject"
           - "s3:ListMultipartUploadParts"
           - "s3:AbortMultipartUpload"
          Resource:
           - !Join [ "/" , [ !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceBucketArn"], !If [ProjectRole, "PrW", "MyW" ] , !Ref RoleID, "*" ] ]
           - !Join [ "/" , [ !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceBucketArn"], "ART", !Ref RoleID, "*" ] ]
        -
          Sid: "AllowReadOfConfigurationAndRawUnstrucDDS"
          Effect: "Allow"
          Action:
           - "s3:GetObject"
          Resource:
           - !Join [ "/" , [ !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceBucketArn"], "Configuration/*" ] ]
           - !Join [ "/" , [ !FindInMap ["EnvironmentMap", !Ref Environment,"UnstruDDSBucketArn"], "dds", !Ref RoleID, "*" ] ]
        -
          Sid: "AllowUseOfKMSKey"
          Effect: "Allow"
          Action:
           - "kms:Decrypt"
           - "kms:Encrypt"
           - "kms:ReEncryptTo"
           - "kms:GenerateDataKey"
           - "kms:DescribeKey"
           - "kms:ReEncryptFrom"
           - "kms:CreateGrant"
          Resource:
           - !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceKmsKeyID"]
           - !FindInMap ["EnvironmentMap", !Ref Environment,"NotebookKmsKeyID"]
           - !FindInMap ["EnvironmentMap", !Ref Environment,"NonPIIBucketKMSKeyID"]
        -
          Sid: "AllowGetAuthorizationToken"
          Effect: "Allow"
          Action:
           - "ecr:GetAuthorizationToken"
          Resource: '*'
        -
          Sid: "AllowUseOfECRRepository"
          Effect: "Allow"
          Action:
           - "ecr:GetDownloadUrlForLayer"
           - "ecr:BatchDeleteImage"
           - "ecr:ListImages"
           - "ecr:SetRepositoryPolicy"
           - "ecr:BatchGetImage"
           - "ecr:DescribeImages"
           - "ecr:TagResource"
           - "ecr:DescribeRepositories"
           - "ecr:BatchCheckLayerAvailability"
           - "ecr:GetAuthorizationToken"
          Resource:
           - !Sub "arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/slf_ca_central_sagemaker_repo"
      Roles:
        - !Ref SagemakerExecutionRole
  SagemakerTrainingIAMPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: NotPersonalRole
    Properties:
      ManagedPolicyName: !Join ["_", [ "slf_aws_sagemaker", "distributed_training", !Ref RoleType, !Ref RoleID, "execution_policy" ] ]
      Description: !Join [" - ", [ "Execution Policy to allow Sagemaker Distributed Training to", !Ref RoleType, !Ref RoleID ] ]
      Path: "/"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        -
          Sid: "AllowEC2ActionsForTransientSagemakerInstances"
          Effect: "Allow"
          Action:
           - "ec2:CreateNetworkInterface"
           - "ec2:DeleteNetworkInterface"
           - "ec2:AttachNetworkInterface"
           - "ec2:DetachNetworkInterface"
           - "ec2:CreateNetworkInterfacePermission"
           - "ec2:DeleteNetworkInterfacePermission"
           - "ec2:ModifyNetworkInterfaceAttribute"
          Resource: '*'
          Condition:
            ForAnyValue:StringEquals:
              "aws:RequestedRegion": !Sub "${AWS::Region}"
        -
          Sid: "AllowAddSagemakerTags"
          Effect: "Allow"
          Action:
           - "sagemaker:AddTags"
          Resource: "*"
        -
          Sid: "AllowCreateSagemakerJobsWithTagCondition"
          Effect: "Allow"
          Action:
           - "sagemaker:CreateTrainingJob"
           - "sagemaker:CreateHyperParameterTuningJob"
           - "sagemaker:CreateTransformJob"
           - "sagemaker:CreateProcessingJob"
          Resource:
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:training-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:hyper-parameter-tuning-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:transform-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:processing-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:labeling-job/", !Ref RoleID, "*" ] ]
          Condition:
            StringEquals:
              "aws:RequestTag/cost_centre": !Ref CostCentre
        -
          Sid: "AllowStopSagemakerJobsWithTagCondition"
          Effect: "Allow"
          Action:
           - "sagemaker:StopTrainingJob"
           - "sagemaker:StopHyperParameterTuningJob"
           - "sagemaker:StopTransformJob"
           - "sagemaker:StopProcessingJob"
          Resource:
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:training-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:hyper-parameter-tuning-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:transform-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:processing-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:labeling-job/", !Ref RoleID, "*" ] ]
          Condition:
            StringEquals:
              "aws:ResourceTag/cost_centre": !Ref CostCentre
        -
          Sid: "AllowCreateDeleteSagemakerObjects"
          Effect: "Allow"
          Action:
           - "sagemaker:CreateModel"
           - "sagemaker:DeleteModel"
           - "sagemaker:CreateAlgorithm"
           - "sagemaker:DeleteAlgorithm"
           - "sagemaker:CreateModelPackage"
          Resource:
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:model/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:algorithm/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:model-package/", !Ref RoleID, "*" ] ]
        -
          Sid: "AllowPassingIAMRoleToSagemakerService"
          Effect: "Allow"
          Action:
           - "iam:PassRole"
          Resource:
           - !Join [ "", [ !Sub "arn:aws:iam::${AWS::AccountId}:role/", "slf_aws_sagemaker", "_", !Ref RoleType, "_", !Ref RoleID, "_", "execution_role" ] ]
          Condition:
            StringEquals:
              "iam:PassedToService": "sagemaker.amazonaws.com"
        -
          Sid: "AllowListOfCloudWatchMetrics"
          Effect: "Allow"
          Action:
           - "cloudwatch:ListMetrics"
          Resource: "*"
        -
          Sid: "AllowUseOfCloudWatchMetrics"
          Effect: "Allow"
          Action:
           - "cloudwatch:GetMetricData"
           - "cloudwatch:PutMetricData"
           - "cloudwatch:GetMetricStatistics"
          Resource: "*"
        -
          Sid: "AllowUseOfCloudWatchAlarms"
          Effect: "Allow"
          Action:
           - "cloudwatch:PutMetricAlarm"
           - "cloudwatch:DeleteAlarms"
           - "cloudwatch:DescribeAlarms"
          Resource: !Sub "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:*"
        -
          Sid: "AllowUseOfCloudWatchLogs"
          Effect: "Allow"
          Action:
           - "logs:CreateLogGroup"
           - "logs:CreateLogStream"
           - "logs:PutLogEvents"
           - "logs:GetLogEvents"
           - "logs:DescribeLogGroups"
           - "logs:DescribeLogStreams"
          Resource: "*"
      Roles:
        - !Ref SagemakerExecutionRole
  DeploymentECRIAMPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: DeploymentRole
    Properties:
      ManagedPolicyName: !Join ["_", [ "slf_aws_sagemaker", !Ref RoleType, !Ref RoleID, "execution_policy" ] ]
      Description: !Join [" - ", [ "Execution Policy for", !Ref RoleType, !Ref RoleID ] ]
      Path: "/"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        -
          Sid: "AllowListingSagemakerObjects"
          Effect: "Allow"
          Action:
           - "sagemaker:ListTags"
           - "sagemaker:ListCodeRepositories"
           - "sagemaker:ListNotebookInstances"
           - "sagemaker:ListTrainingJobs"
           - "sagemaker:ListHyperParameterTuningJobs"
           - "sagemaker:ListTrainingJobsForHyperParameterTuningJob"
           - "sagemaker:ListModels"
           - "sagemaker:ListTransformJobs"
           - "sagemaker:ListAlgorithms"
           - "sagemaker:ListModelPackages"
           - "sagemaker:ListProcessingJobs"
          Resource: "*"
        -
          Sid: "DescribeSagemakerObjects"
          Effect: "Allow"
          Action:
           - "sagemaker:DescribeNotebookInstance"
           - "sagemaker:DescribeTrainingJob"
           - "sagemaker:DescribeHyperParameterTuningJob"
           - "sagemaker:DescribeModel"
           - "sagemaker:DescribeAlgorithm"
           - "sagemaker:DescribeModelPackage"
           - "sagemaker:DescribeTransformJob"
           - "sagemaker:DescribeCodeRepository"
           - "sagemaker:DescribeProcessingJob"
          Resource:
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:notebook-instance/", !Join ["-", [ "*", !Ref RoleID, "deploy" ] ] ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:training-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:hyper-parameter-tuning-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:algorithm/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:model/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:model-package/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:transform-job/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:code-repository/", !Ref RoleID, "*" ] ]
           - !Join [ "" , [ !Sub "arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:processing-job/", !Ref RoleID, "*" ] ]
        -
          Sid: "AllowDescribeVPCInfo"
          Effect: "Allow"
          Action:
           - "ec2:DescribeVpcs"
           - "ec2:DescribeDhcpOptions"
           - "ec2:DescribeSubnets"
           - "ec2:DescribeSecurityGroups"
           - "ec2:DescribeAvailabilityZones"
           - "ec2:DescribeInternetGateways"
           - "ec2:DescribeNetworkInterfaces"
          Resource: '*'
          Condition:
            ForAnyValue:StringEquals:
              "aws:RequestedRegion": !Sub "${AWS::Region}"
        -
          Sid: "AllowBucketLocationPermissions"
          Effect: "Allow"
          Action:
           - "s3:GetBucketLocation"
          Resource: !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceBucketArn"]
        -
          Sid: "AllowListS3BucketWithPrefix"
          Effect: "Allow"
          Action:
           - "s3:ListBucket"
          Resource:
           - !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceBucketArn"]
           - !FindInMap ["EnvironmentMap", !Ref Environment,"UnstruDDSBucketArn"]
          Condition:
            ForAnyValue:StringLike:
              "s3:prefix":
               - !Join [ "" , [ "PrW", "/", !Ref RoleID, "/", "*" ] ]
               - !Join [ "" , [ "ART", "/", !Ref RoleID, "/", "*" ] ]
               - "Configuration/*"
               - !Join [ "" , [ "dds", "/", !Ref RoleID, "/", "*" ] ]
        -
          Sid: "AllowListS3BucketNonPiiWithPrefix"
          Effect: "Allow"
          Action:
           - "s3:ListBucket"
          Resource:
           - !FindInMap ["EnvironmentMap", !Ref Environment,"NonPIIBucketArn"]
          Condition:
            ForAnyValue:StringLike:
              "s3:prefix":
               - "cur/*"
               - "der/*"
               - "dds/*"
        -
          Sid: "AllowReadOfNonPiiBucket"
          Effect: "Allow"
          Action:
           - "s3:GetObject"
          Resource:
           - !If [GovtClear, !Join [ "/" , [ !FindInMap ["EnvironmentMap", !Ref Environment,"NonPIIBucketArn"], "*" ] ], !Join [ "/" , [ !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceBucketArn"], "PrW", "nonpiidenied", "*" ] ] ]
        -
          Sid: "AllowReadWriteToWorkspaceAndArtifacts"
          Effect: "Allow"
          Action:
           - "s3:ListObjectsV2"
           - "s3:PutObject"
           - "s3:GetObject"
           - "s3:DeleteObject"
           - "s3:ListMultipartUploadParts"
           - "s3:AbortMultipartUpload"
          Resource:
           - !Join [ "/" , [ !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceBucketArn"], "PrW" , !Ref RoleID, "*" ] ]
           - !Join [ "/" , [ !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceBucketArn"], "ART", !Ref RoleID, "*" ] ]
        -
          Sid: "AllowReadOfConfigurationAndRawUnstrucDDS"
          Effect: "Allow"
          Action:
           - "s3:GetObject"
          Resource:
           - !Join [ "/" , [ !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceBucketArn"], "Configuration/*" ] ]
           - !Join [ "/" , [ !FindInMap ["EnvironmentMap", !Ref Environment,"UnstruDDSBucketArn"], "dds", !Ref RoleID, "*" ] ]
        -
          Sid: "AllowUseOfKMSKey"
          Effect: "Allow"
          Action:
           - "kms:Decrypt"
           - "kms:Encrypt"
           - "kms:ReEncryptTo"
           - "kms:GenerateDataKey"
           - "kms:DescribeKey"
           - "kms:ReEncryptFrom"
           - "kms:CreateGrant"
          Resource:
           - !FindInMap ["EnvironmentMap", !Ref Environment,"WorkspaceKmsKeyID"]
           - !FindInMap ["EnvironmentMap", !Ref Environment,"NotebookKmsKeyID"]
           - !FindInMap ["EnvironmentMap", !Ref Environment,"NonPIIBucketKMSKeyID"]
        -
          Sid: "AllowGetAuthorizationToken"
          Effect: "Allow"
          Action:
           - "ecr:GetAuthorizationToken"
          Resource: '*'
        -
          Sid: "AllowUseOfECRRepository"
          Effect: "Allow"
          Action:
           - "ecr:GetDownloadUrlForLayer"
           - "ecr:UploadLayerPart"
           - "ecr:BatchDeleteImage"
           - "ecr:ListImages"
           - "ecr:PutImage"
           - "ecr:SetRepositoryPolicy"
           - "ecr:BatchGetImage"
           - "ecr:CompleteLayerUpload"
           - "ecr:DescribeImages"
           - "ecr:TagResource"
           - "ecr:DescribeRepositories"
           - "ecr:InitiateLayerUpload"
           - "ecr:BatchCheckLayerAvailability"
           - "ecr:GetAuthorizationToken"
          Resource:
           - !Sub "arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/slf_ca_central_sagemaker_repo"
           - !Sub "arn:aws:ecr:${AWS::Region}:341280168497:repository/*"
           - !Sub "arn:aws:ecr:${AWS::Region}:763104351884:repository/*"
           - !Sub "arn:aws:ecr:${AWS::Region}:520713654638:repository/*"
      Roles:
        - !Ref SagemakerExecutionRole
Outputs:
  SagemakerExecutionRole:
    Value: !Ref SagemakerExecutionRole
    Export:
      Name: !Sub "${AWS::StackName}-SagemakerExecutionRole"
